<%
  content_html = local_assigns[:content_html].to_s
  input_name = local_assigns[:input_name]
  draft_key = local_assigns[:draft_key]
  content_html = transform_embeds_for_editor(content_html)
%>
<div data-controller="wiki-editor" class="wiki-editor"<%= " data-wiki-editor-draft-key-value=\"#{draft_key}\"" if draft_key.present? %>>
  <div class="wiki-editor-toolbar">
    <button type="button" data-action="click->wiki-editor#bold" data-format="bold" class="wiki-editor-btn" title="Bold"><svg class="wiki-editor-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M15.6 10.79c.97-.67 1.65-1.77 1.65-2.79 0-2.26-1.75-4-4-4H7v14h7.04c2.09 0 3.71-1.7 3.71-3.79 0-1.52-.86-2.82-2.15-3.42zM10 6.5h3c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-3v-3zm3.5 9H10v-3h3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"/></svg></button>
    <button type="button" data-action="click->wiki-editor#italic" data-format="italic" class="wiki-editor-btn" title="Italic"><svg class="wiki-editor-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"/></svg></button>
    <button type="button" data-action="click->wiki-editor#openLinkModal" class="wiki-editor-btn" title="Link"><svg class="wiki-editor-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></button>
    <div class="wiki-editor-heading-group">
      <button type="button" data-action="click->wiki-editor#formatBlock" data-format-param="h2" data-format="h2" class="wiki-editor-btn" title="Heading 2">H2</button>
      <button type="button" data-action="click->wiki-editor#formatBlock" data-format-param="h3" data-format="h3" class="wiki-editor-btn" title="Heading 3">H3</button>
    </div>
    <button type="button" data-action="click->wiki-editor#quote" data-format="blockquote" class="wiki-editor-btn" title="Quote"><svg class="wiki-editor-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 17h3l2-4V7H5v6h3zm8 0h3l2-4V7h-6v6h3z"/></svg></button>
    <button type="button" data-action="click->wiki-editor#insertUnorderedList" data-format="bulletList" class="wiki-editor-btn" title="Bullet list"><svg class="wiki-editor-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M4 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0-6c-.83 0-1.5.67-1.5 1.5S3.17 7.5 4 7.5 5.5 6.83 5.5 6 4.83 4.5 4 4.5zm0 12c-.83 0-1.5.68-1.5 1.5s.68 1.5 1.5 1.5 1.5-.68 1.5-1.5-.67-1.5-1.5-1.5zM7 19h14v-2H7v2zm0-6h14v-2H7v2zm0-8v2h14V5H7z"/></svg></button>
    <button type="button" data-action="click->wiki-editor#insertOrderedList" data-format="orderedList" class="wiki-editor-btn" title="Numbered list"><svg class="wiki-editor-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M2 17h2v.5H3v1h1v.5H2v1h3v-4H2v1zm1-9h1V4H2v1h1v3zm-1 3h1.8L2 13.1v.9h3v-1H3.2L5 10.9V10H2v1zm5-6v2h14V5H7zm0 14h14v-2H7v2zm0-6h14v-2H7v2z"/></svg></button>
    <button type="button" data-action="click->wiki-editor#openEmbedModal" class="wiki-editor-btn" title="Embed"><svg class="wiki-editor-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg></button>
    <% if draft_key.present? %>
      <span data-wiki-editor-target="draftLinkWrap" class="wiki-editor-draft-link-wrap" hidden>
        <button type="button" data-action="click->wiki-editor#restoreDraftFromLink" class="wiki-editor-draft-link" data-wiki-editor-target="draftLink">Restore draft</button>
      </span>
    <% end %>
  </div>
  <div class="wiki-editor-body">
    <div data-wiki-editor-target="editor" class="wiki-editor-mount"><%= content_html.html_safe %></div>
    <input type="hidden" data-wiki-editor-target="input" name="<%= input_name %>" value="">
  </div>
  <div data-wiki-editor-target="linkBubble" class="wiki-link-bubble" hidden role="toolbar">
    <button type="button" data-action="click->wiki-editor#openLinkModalFromBubble" class="wiki-link-bubble-btn">Edit</button>
    <button type="button" data-action="click->wiki-editor#unlinkFromBubble" class="wiki-link-bubble-btn wiki-link-bubble-btn--danger">Unlink</button>
  </div>
  <div data-wiki-editor-target="linkModal" class="wiki-link-modal" hidden>
    <div class="wiki-link-modal-backdrop" data-action="click->wiki-editor#closeLinkModal"></div>
    <div class="wiki-link-modal-box">
      <div class="wiki-link-modal-row">
        <label for="wiki-link-text">Link text</label>
        <input type="text" data-wiki-editor-target="linkText" id="wiki-link-text" placeholder="Link text">
      </div>
      <div class="wiki-link-modal-row">
        <label for="wiki-link-url">URL</label>
        <input type="url" data-wiki-editor-target="linkUrl" id="wiki-link-url" placeholder="https://...">
      </div>
      <div class="wiki-link-modal-actions">
        <button type="button" data-action="click->wiki-editor#applyLink" class="wiki-link-modal-btn wiki-link-modal-btn--primary" >Insert link</button>
        <button type="button" data-action="click->wiki-editor#unlink" class="wiki-link-modal-btn wiki-link-modal-btn--danger" data-wiki-editor-target="unlinkBtn" hidden>Unlink</button>
        <button type="button" data-action="click->wiki-editor#closeLinkModal" class="wiki-link-modal-btn">Cancel</button>
      </div>
    </div>
  </div>
  <div data-wiki-editor-target="embedModal" class="wiki-link-modal wiki-embed-modal" hidden>
    <div class="wiki-link-modal-backdrop" data-action="click->wiki-editor#closeEmbedModal"></div>
    <div class="wiki-link-modal-box">
      <div class="wiki-link-modal-row">
        <label for="wiki-embed-code">Embed code</label>
        <textarea data-wiki-editor-target="embedCode" id="wiki-embed-code" placeholder="Paste iframe embed code (e.g. from YouTube, Vimeo)..." rows="4"></textarea>
      </div>
      <div class="wiki-link-modal-actions">
        <button type="button" data-action="click->wiki-editor#applyEmbed" class="wiki-link-modal-btn wiki-link-modal-btn--primary">Insert</button>
        <button type="button" data-action="click->wiki-editor#closeEmbedModal" class="wiki-link-modal-btn">Cancel</button>
      </div>
    </div>
  </div>
</div>
